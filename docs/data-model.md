# Data Model Documentation

## Overview

This document describes the complete client-side data model for the 3D Print Pro application. All data is currently stored in browser `localStorage` under the key `3dprintpro_data`. This documentation serves as the single source of truth for backend implementation, database schema design, and API development.

## Storage Architecture

### Storage Key
- **Key**: `3dprintpro_data`
- **Format**: JSON string
- **Structure**: Root object with named collections

### Root Data Structure
```json
{
  "orders": [],
  "services": [],
  "portfolio": [],
  "testimonials": [],
  "faq": [],
  "settings": [{}],
  "content": [{}],
  "stats": {}
}
```

### Common Metadata Fields
All items created through the Database class automatically receive:
- `id` (String): Unique identifier (timestamp + random string)
- `createdAt` (ISO 8601 String): Creation timestamp
- `updatedAt` (ISO 8601 String): Last update timestamp

---

## 1. Orders Collection

### Description
Stores both calculator-based orders and general contact form submissions. Serves as the primary lead/inquiry management system.

### Table Name
`orders`

### Fields

| Field Name | Type | Required | Default | Description | Validation Rules |
|------------|------|----------|---------|-------------|------------------|
| `id` | String | Yes | Auto | Unique identifier | Generated by system |
| `type` | String (Enum) | Yes | 'contact' | Type of submission | 'order' or 'contact' |
| `orderNumber` | String | Yes | Auto | Human-readable order ID | Generated: 'ORD-' + timestamp |
| `status` | String (Enum) | Yes | 'new' | Order status | 'new', 'processing', 'completed', 'cancelled' |
| `clientName` | String | Yes | - | Client's full name | Min 2 chars, max 100 chars |
| `name` | String | Yes | - | Alias for clientName | Duplicate for compatibility |
| `clientEmail` | String | Yes | - | Client's email | Valid email format |
| `email` | String | Yes | - | Alias for clientEmail | Duplicate for compatibility |
| `clientPhone` | String | Yes | - | Client's phone number | Russian phone format |
| `phone` | String | Yes | - | Alias for clientPhone | Duplicate for compatibility |
| `telegram` | String | No | '' | Telegram username | Optional, format: @username |
| `service` | String | Yes | - | Service name | Name of requested service |
| `subject` | String | No | '' | Subject/theme | For contact forms |
| `amount` | Number | Yes | 0 | Order amount in rubles | Min 0, integer |
| `message` | String | No | '' | Client message | Max 5000 chars |
| `details` | String | No | '' | Alias for message | Duplicate for compatibility |
| `calculatorData` | Object | No | null | Calculator results | See Calculator Data structure |
| `telegramSent` | Boolean | Yes | false | Telegram notification status | true if sent successfully |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp | ISO 8601 format |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp | ISO 8601 format |

### Calculator Data Structure
When `type` is 'order', this nested object contains:

```json
{
  "technology": "fdm|sla|sls",
  "material": "String (material name)",
  "weight": "Number (grams)",
  "quantity": "Number (units)",
  "infill": "Number (percentage 0-100)",
  "quality": "String (quality level name)",
  "materialCost": "Number (rubles)",
  "laborCost": "Number (rubles)",
  "additionalCost": "Number (rubles)",
  "discount": "Number (rubles)",
  "discountPercent": "Number (percentage)",
  "total": "Number (rubles)",
  "timeEstimate": "String (e.g., '3 дня')",
  "service": "String (service description)",
  "details": "String (formatted details)"
}
```

### Status State Machine

```
new → processing → completed
  ↓
cancelled
```

### Relationships
- References `services.name` via `service` field (soft reference)
- No foreign keys (document-style storage)

### Indexes Needed (Future)
- `status` (for filtering)
- `type` (for filtering)
- `createdAt` (for sorting, descending)
- `clientEmail` (for customer lookup)
- `orderNumber` (for search)

### API Endpoints Needed
- `POST /api/orders` - Create new order
- `GET /api/orders` - List orders (with filters: status, type, search, pagination)
- `GET /api/orders/:id` - Get single order
- `PUT /api/orders/:id` - Update order
- `DELETE /api/orders/:id` - Delete order
- `PATCH /api/orders/:id/status` - Update status only
- `POST /api/orders/:id/resend-telegram` - Resend Telegram notification

### Data Transformations for Backend
1. **Denormalization**: `clientName/name`, `clientEmail/email`, `clientPhone/phone`, `message/details` should be consolidated
2. **Normalize to**: Single fields: `name`, `email`, `phone`, `message`
3. **Order numbering**: Generate server-side with sequence/counter
4. **Telegram integration**: Move to async job queue

---

## 2. Services Collection

### Description
Catalog of services offered by the business. Displayed on the main site and used in modals. Supports ordering and featuring.

### Table Name
`services`

### Fields

| Field Name | Type | Required | Default | Description | Validation Rules |
|------------|------|----------|---------|-------------|------------------|
| `id` | String | Yes | Auto | Unique identifier | Generated by system |
| `name` | String | Yes | - | Service name | Max 100 chars |
| `slug` | String | Yes | - | URL-friendly identifier | Lowercase, hyphens, unique |
| `icon` | String | Yes | - | FontAwesome icon class | Format: 'fa-cube' |
| `description` | String | Yes | - | Service description | Max 500 chars |
| `features` | Array[String] | Yes | [] | List of features/benefits | 3-6 items recommended |
| `price` | String | Yes | - | Price display text | E.g., 'от 50₽/г' |
| `active` | Boolean | Yes | true | Visibility status | Only active shown on site |
| `featured` | Boolean | Yes | false | Popular/featured flag | Show special badge |
| `order` | Number | Yes | 0 | Display order | Lower numbers first |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp | ISO 8601 format |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp | ISO 8601 format |

### Default Services
The system ships with 6 default services:
1. FDM печать (slug: fdm)
2. SLA/SLS печать (slug: sla) - Featured
3. Post-обработка (slug: post)
4. 3D моделирование (slug: modeling)
5. 3D сканирование (slug: scanning)
6. Мелкосерийное производство (slug: production)

### Constraints
- `slug` must be unique
- `order` must be positive integer
- `features` array should have at least 3 items

### Indexes Needed (Future)
- `slug` (unique)
- `active` (for filtering)
- `order` (for sorting)
- `featured` (for filtering)

### API Endpoints Needed
- `GET /api/services` - List services (with filter: active)
- `GET /api/services/:slug` - Get service by slug
- `POST /api/services` - Create service (admin)
- `PUT /api/services/:id` - Update service (admin)
- `DELETE /api/services/:id` - Delete service (admin)
- `PATCH /api/services/:id/order` - Reorder services (admin)

---

## 3. Portfolio Collection

### Description
Showcase of completed projects. Filterable by category. Used in portfolio gallery section.

### Table Name
`portfolio`

### Fields

| Field Name | Type | Required | Default | Description | Validation Rules |
|------------|------|----------|---------|-------------|------------------|
| `id` | String | Yes | Auto | Unique identifier | Generated by system |
| `title` | String | Yes | - | Project title | Max 200 chars |
| `category` | String (Enum) | Yes | - | Project category | See categories below |
| `description` | String | Yes | - | Short description | Max 500 chars |
| `image` | String (URL) | Yes | - | Project image URL | Valid URL or relative path |
| `details` | String | No | '' | Extended details | Max 2000 chars |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp | ISO 8601 format |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp | ISO 8601 format |

### Category Enum
```javascript
{
  'prototype': 'Прототипы',
  'functional': 'Функциональные',
  'art': 'Художественные',
  'industrial': 'Промышленные'
}
```

### Constraints
- `category` must be one of the enum values
- `image` should be validated for existence (if using uploads)

### Indexes Needed (Future)
- `category` (for filtering)
- `createdAt` (for sorting, descending)

### API Endpoints Needed
- `GET /api/portfolio` - List portfolio items (with filter: category)
- `GET /api/portfolio/:id` - Get single item
- `POST /api/portfolio` - Create item (admin)
- `PUT /api/portfolio/:id` - Update item (admin)
- `DELETE /api/portfolio/:id` - Delete item (admin)
- `POST /api/portfolio/:id/upload-image` - Upload image (admin)

### Data Transformations for Backend
- Store images in CDN/object storage
- Store only CDN URL in database
- Generate thumbnails on upload

---

## 4. Testimonials Collection

### Description
Customer reviews and testimonials. Requires approval before display. Sortable by order.

### Table Name
`testimonials`

### Fields

| Field Name | Type | Required | Default | Description | Validation Rules |
|------------|------|----------|---------|-------------|------------------|
| `id` | String | Yes | Auto | Unique identifier | Generated by system |
| `name` | String | Yes | - | Customer name | Max 100 chars |
| `position` | String | Yes | - | Job title/role | Max 100 chars |
| `avatar` | String (URL) | Yes | - | Avatar image URL | Valid URL |
| `rating` | Number | Yes | 5 | Star rating | Integer 1-5 |
| `text` | String | Yes | - | Review text | Max 1000 chars |
| `approved` | Boolean | Yes | false | Approval status | Only approved shown on site |
| `order` | Number | Yes | 0 | Display order | Lower numbers first |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp | ISO 8601 format |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp | ISO 8601 format |

### Default Testimonials
System ships with 4 approved testimonials with 5-star ratings.

### Constraints
- `rating` must be integer between 1-5
- `order` must be positive integer
- Only `approved=true` items shown publicly

### Indexes Needed (Future)
- `approved` (for filtering)
- `order` (for sorting)
- `rating` (for filtering/analytics)

### API Endpoints Needed
- `GET /api/testimonials` - List testimonials (public: approved only)
- `GET /api/testimonials/:id` - Get single testimonial
- `POST /api/testimonials` - Create testimonial (may be public submission)
- `PUT /api/testimonials/:id` - Update testimonial (admin)
- `DELETE /api/testimonials/:id` - Delete testimonial (admin)
- `PATCH /api/testimonials/:id/approve` - Approve/reject (admin)

---

## 5. FAQ Collection

### Description
Frequently Asked Questions. Can be enabled/disabled individually. Sortable by order.

### Table Name
`faq`

### Fields

| Field Name | Type | Required | Default | Description | Validation Rules |
|------------|------|----------|---------|-------------|------------------|
| `id` | String | Yes | Auto | Unique identifier | Generated by system |
| `question` | String | Yes | - | Question text | Max 500 chars |
| `answer` | String | Yes | - | Answer text | Max 2000 chars, HTML allowed |
| `active` | Boolean | Yes | true | Visibility status | Only active shown on site |
| `order` | Number | Yes | 0 | Display order | Lower numbers first |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp | ISO 8601 format |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp | ISO 8601 format |

### Default FAQ Items
System ships with 6 active FAQ items covering:
- File formats
- Manufacturing time
- Wall thickness requirements
- Post-processing options
- Volume discounts
- Payment methods

### Constraints
- `order` must be positive integer
- Only `active=true` items shown publicly

### Indexes Needed (Future)
- `active` (for filtering)
- `order` (for sorting)

### API Endpoints Needed
- `GET /api/faq` - List FAQ items (with filter: active)
- `GET /api/faq/:id` - Get single item
- `POST /api/faq` - Create item (admin)
- `PUT /api/faq/:id` - Update item (admin)
- `DELETE /api/faq/:id` - Delete item (admin)

---

## 6. Settings Collection (Singleton)

### Description
Global site settings and configuration. Stored as a single-element array but conceptually a singleton. Contains site metadata, contact info, theme, integrations, and calculator pricing configuration.

### Storage Structure
`settings: [{ ...settingsObject }]`

### Table Name
`settings` (or consider renaming to `site_settings`)

### Fields

| Field Name | Type | Required | Default | Description |
|------------|------|----------|---------|-------------|
| `id` | String | Yes | Auto | Unique identifier |
| `siteName` | String | Yes | '3D Print Pro' | Site name |
| `siteDescription` | String | Yes | - | Site tagline/description |
| `contactEmail` | String | Yes | - | Contact email |
| `contactPhone` | String | Yes | - | Contact phone |
| `address` | String | Yes | - | Physical address |
| `workingHours` | String | Yes | - | Working hours (multiline) |
| `timezone` | String | Yes | 'Europe/Moscow' | Timezone |
| `socialLinks` | Object | Yes | {} | Social media URLs |
| `theme` | String | Yes | 'light' | Theme preference |
| `colorPrimary` | String | Yes | '#6366f1' | Primary color (hex) |
| `colorSecondary` | String | Yes | '#ec4899' | Secondary color (hex) |
| `notifications` | Object | Yes | {} | Notification preferences |
| `telegram` | Object | Yes | {} | Telegram settings |
| `telegramNotifications` | Boolean | Yes | true | Enable Telegram notifications |
| `formFields` | Object | Yes | {} | Dynamic form configuration |
| `calculator` | Object | Yes | {} | Calculator pricing config |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp |

### Nested Object: socialLinks
```json
{
  "vk": "String (URL)",
  "telegram": "String (URL)",
  "whatsapp": "String (URL)",
  "youtube": "String (URL)"
}
```

### Nested Object: notifications
```json
{
  "newOrders": "Boolean",
  "newReviews": "Boolean",
  "newMessages": "Boolean"
}
```

### Nested Object: telegram
```json
{
  "chatId": "String (Telegram chat ID)"
}
```

### Nested Object: formFields
```json
{
  "contact": [
    {
      "name": "String (field name)",
      "label": "String (display label)",
      "type": "String (input type)",
      "required": "Boolean",
      "enabled": "Boolean",
      "placeholder": "String",
      "order": "Number",
      "options": ["Array of strings (for select)"]
    }
  ],
  "order": []
}
```

**Default Contact Form Fields:**
1. name (text, required)
2. email (email, required)
3. phone (tel, required)
4. telegram (text, optional)
5. subject (select, optional) - Options: 'Расчет стоимости', 'Консультация', 'Партнерство', 'Другое'
6. message (textarea, required)

### Nested Object: calculator
```json
{
  "materialPrices": {
    "pla": { "name": "PLA", "price": 50, "technology": "fdm" },
    "abs": { "name": "ABS", "price": 60, "technology": "fdm" },
    "petg": { "name": "PETG", "price": 70, "technology": "fdm" },
    "nylon": { "name": "Nylon", "price": 120, "technology": "fdm" },
    "tpu": { "name": "TPU (Flex)", "price": 150, "technology": "fdm" },
    "standard_resin": { "name": "Standard Resin", "price": 200, "technology": "sla" },
    "tough_resin": { "name": "Tough Resin", "price": 250, "technology": "sla" },
    "flexible_resin": { "name": "Flexible Resin", "price": 280, "technology": "sla" },
    "pa12": { "name": "PA12 Nylon", "price": 150, "technology": "sls" },
    "tpu_sls": { "name": "TPU SLS", "price": 180, "technology": "sls" }
  },
  "servicePrices": {
    "modeling": { "name": "3D моделирование", "price": 500, "unit": "час" },
    "postProcessing": { "name": "Постобработка", "price": 300, "unit": "шт" },
    "painting": { "name": "Покраска", "price": 500, "unit": "шт" },
    "express": { "name": "Срочное изготовление", "price": 1000, "unit": "заказ" }
  },
  "qualityMultipliers": {
    "draft": { "name": "Черновое", "multiplier": 0.8, "time": 0.7 },
    "normal": { "name": "Нормальное", "multiplier": 1.0, "time": 1.0 },
    "high": { "name": "Высокое", "multiplier": 1.3, "time": 1.4 },
    "ultra": { "name": "Ультра", "multiplier": 1.6, "time": 2.0 }
  },
  "discounts": [
    { "minQuantity": 10, "percent": 10 },
    { "minQuantity": 50, "percent": 15 },
    { "minQuantity": 100, "percent": 20 }
  ]
}
```

### Constraints
- Only one settings record should exist
- Email must be valid format
- Phone must be valid format
- Hex colors must be valid
- Timezone must be valid IANA timezone

### API Endpoints Needed
- `GET /api/settings` - Get settings
- `PUT /api/settings` - Update settings (admin)
- `GET /api/settings/calculator` - Get calculator config (public)
- `PUT /api/settings/calculator` - Update calculator config (admin)
- `POST /api/settings/telegram/test` - Send test Telegram message (admin)

### Data Transformations for Backend
1. **Flatten structure**: Consider breaking into separate tables:
   - `site_settings` (basic info)
   - `calculator_materials` (normalized)
   - `calculator_services` (normalized)
   - `calculator_quality_levels` (normalized)
   - `calculator_discounts` (normalized)
   - `form_fields` (normalized)
2. **Separate concerns**: Telegram settings could be in separate `integrations` table

---

## 7. Content Collection (Singleton)

### Description
Editable site content for hero section and about section. Stored as single-element array but conceptually a singleton.

### Storage Structure
`content: [{ ...contentObject }]`

### Table Name
`content` (or consider renaming to `site_content`)

### Fields

| Field Name | Type | Required | Default | Description |
|------------|------|----------|---------|-------------|
| `id` | String | Yes | Auto | Unique identifier |
| `hero` | Object | Yes | {} | Hero section content |
| `about` | Object | Yes | {} | About section content |
| `createdAt` | String (ISO) | Yes | Auto | Creation timestamp |
| `updatedAt` | String (ISO) | Yes | Auto | Last update timestamp |

### Nested Object: hero
```json
{
  "title": "String (main heading)",
  "subtitle": "String (tagline/description)",
  "features": ["Array of 3 short features"]
}
```

**Default:**
```json
{
  "title": "идеи в реальность",
  "subtitle": "Профессиональная 3D печать любой сложности. Быстро, качественно, доступно.",
  "features": [
    "Печать от 1 часа",
    "15+ материалов",
    "Гарантия качества"
  ]
}
```

### Nested Object: about
```json
{
  "title": "String (section heading)",
  "description": "String (main text)",
  "features": [
    {
      "title": "String (feature title)",
      "description": "String (feature description)"
    }
  ]
}
```

**Default:**
```json
{
  "title": "Лидеры в области 3D печати",
  "description": "Мы - команда профессионалов с более чем 12-летним опытом...",
  "features": [
    {
      "title": "Современное оборудование",
      "description": "Работаем на принтерах последнего поколения"
    },
    {
      "title": "Опытная команда",
      "description": "15 специалистов с профильным образованием"
    },
    {
      "title": "Гарантия качества",
      "description": "Все изделия проходят контроль качества"
    }
  ]
}
```

### Constraints
- Only one content record should exist
- Hero features array should have exactly 3 items
- About features array should have at least 3 items

### API Endpoints Needed
- `GET /api/content` - Get content
- `PUT /api/content` - Update content (admin)
- `GET /api/content/hero` - Get hero section
- `GET /api/content/about` - Get about section
- `PUT /api/content/hero` - Update hero section (admin)
- `PUT /api/content/about` - Update about section (admin)

### Data Transformations for Backend
1. Consider flattening into `content_sections` table with type field
2. Each section could be a separate row with JSON content

---

## 8. Stats Collection (Singleton)

### Description
Site statistics displayed in the stats/achievements section. Simple object (not array).

### Storage Structure
`stats: { ...statsObject }`

### Table Name
`stats` (or consider renaming to `site_stats`)

### Fields

| Field Name | Type | Required | Default | Description |
|------------|------|----------|---------|-------------|
| `totalProjects` | Number | Yes | 1500 | Total projects completed |
| `happyClients` | Number | Yes | 850 | Number of happy clients |
| `yearsExperience` | Number | Yes | 12 | Years in business |
| `awards` | Number | Yes | 25 | Awards won |

### Constraints
- All values must be non-negative integers
- These are manually updated (not auto-calculated)

### API Endpoints Needed
- `GET /api/stats` - Get stats
- `PUT /api/stats` - Update stats (admin)

### Data Transformations for Backend
- Could be stored in `settings` table as JSON field
- Or separate `stats` table with single row

---

## Additional Data Entities (Not in localStorage)

### Admin Authentication
Currently handled via `localStorage.setItem('adminAuth', ...)` separately from main data.

**Structure:**
```json
{
  "id": 1,
  "login": "admin",
  "name": "Администратор",
  "role": "admin",
  "loginTime": "ISO 8601 timestamp"
}
```

**Notes:**
- Hardcoded credentials: admin/admin123
- Should be replaced with proper authentication system
- Need user management table with hashed passwords

### Theme Preference
Stored separately: `localStorage.getItem('theme')` → 'light' or 'dark'

**Notes:**
- Could be merged into user preferences
- Or kept in settings for default theme

---

## Data Import/Export

### Export Format
The Database class provides `exportData()` which exports all data as JSON:

```json
{
  "orders": [...],
  "services": [...],
  "portfolio": [...],
  "testimonials": [...],
  "faq": [...],
  "settings": [...],
  "content": [...],
  "stats": {...}
}
```

**Filename format**: `3dprintpro_backup_YYYY-MM-DD.json`

### Import Format
Same JSON structure as export. Imported via `importData(jsonString)`.

**Migration considerations:**
- Need validation on import
- Should preserve IDs during migration
- May need data transformation scripts for:
  - Consolidating duplicate fields (clientName/name)
  - Normalizing calculator configuration
  - Converting settings/content from arrays to single objects

---

## Validation Rules Summary

### Email Validation
Pattern: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`

### Phone Validation (Russian)
Pattern: `/^(\+7|8)?[\s\-]?\(?[489][0-9]{2}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/`

Example valid formats:
- +7 (999) 123-45-67
- 8-999-123-45-67
- 89991234567

### File Uploads (Referenced in CONFIG)
- Max file size: 10MB
- Allowed types: .stl, .obj, .3mf, .step, .stp
- Currently not stored in database

---

## Computed/Derived Fields

### Order Number Generation
```javascript
generateOrderNumber() {
    return 'ORD-' + Date.now();
}
```

**Backend consideration**: Use database sequences or UUID for better uniqueness.

### Calculator Pricing
All pricing is computed client-side based on:
1. Material price per gram
2. Weight × infill factor (30% base + up to 70% variable)
3. Labor cost (base 500₽ + weight × 2₽)
4. Quality multiplier
5. Quantity
6. Additional services
7. Volume discounts

**Backend consideration**: Server should validate and recalculate prices to prevent tampering.

---

## Normalization Recommendations

### For Relational Database Schema

1. **Orders Table**
   - Consolidate duplicate fields (name/clientName, etc.)
   - Extract calculator data into separate `order_calculator_details` table
   - Add foreign key to `services.id` instead of storing service name

2. **Settings Singleton**
   - Break into multiple tables:
     - `site_settings` (basic site info)
     - `materials` (id, name, price, technology, active)
     - `additional_services` (id, name, price, unit, active)
     - `quality_levels` (id, name, multiplier, time_multiplier)
     - `volume_discounts` (id, min_quantity, percent)
     - `integrations` (telegram_bot_token, telegram_chat_id, etc.)

3. **Form Fields**
   - Create `form_field_definitions` table
   - Columns: id, form_type, field_name, label, type, required, enabled, order, options (JSON)

4. **Content Singleton**
   - Create `content_sections` table
   - Columns: id, section_key, title, content (JSON), updated_at

### Many-to-Many Relationships (Future)
If services need to reference materials or quality levels:
- `service_materials` (service_id, material_id)
- `service_quality_levels` (service_id, quality_level_id)

---

## Enumerations for Backend

```sql
-- Order Types
CREATE TYPE order_type AS ENUM ('order', 'contact');

-- Order Statuses
CREATE TYPE order_status AS ENUM ('new', 'processing', 'completed', 'cancelled');

-- Portfolio Categories
CREATE TYPE portfolio_category AS ENUM ('prototype', 'functional', 'art', 'industrial');

-- Print Technologies
CREATE TYPE print_technology AS ENUM ('fdm', 'sla', 'sls');

-- Form Field Types
CREATE TYPE form_field_type AS ENUM ('text', 'email', 'tel', 'textarea', 'select', 'checkbox', 'file', 'number', 'url', 'date');

-- Service Units
CREATE TYPE service_unit AS ENUM ('час', 'шт', 'заказ');
```

---

## Seeding Requirements

### Initial Data Load
The system requires these default datasets on first launch:

1. **Services**: 6 default services (see section 2)
2. **Testimonials**: 4 default testimonials (see section 4)
3. **FAQ**: 6 default FAQ items (see section 5)
4. **Settings**: One default settings object with full calculator config (see section 6)
5. **Content**: One default content object with hero/about (see section 7)
6. **Stats**: One default stats object (see section 8)

### Seed Data Files
Consider creating:
- `seeds/services.json`
- `seeds/testimonials.json`
- `seeds/faq.json`
- `seeds/settings.json`
- `seeds/content.json`
- `seeds/stats.json`

---

## Integration Points

### Telegram Bot Integration
- Bot Token: Stored in CONFIG and settings
- Chat ID: Retrieved from settings.telegram.chatId
- Message formats: See `js/telegram.js` for HTML formatting
- Notifications sent for:
  - New orders (with calculator details)
  - Contact form submissions

**API methods needed:**
- `POST /api/integrations/telegram/get-updates` - Get chat ID
- `POST /api/integrations/telegram/send-test` - Send test message
- Webhook support for receiving messages (future)

### External Services
Currently no external integrations except Telegram. Future considerations:
- Payment gateway integration
- Email service (SendGrid, Mailgun)
- SMS notifications
- File storage (AWS S3, Cloudinary)

---

## Data Consistency Rules

1. **Settings & Content**: Only one record should exist
2. **Order numbering**: Must be unique and sequential
3. **Service slugs**: Must be unique across all services
4. **Active flags**: Used for soft deletes, never hard delete services/FAQ
5. **Calculator sync**: CONFIG in config.js loads from settings - backend must ensure consistency
6. **Form fields**: Changes to form fields must be validated against existing orders
7. **Status transitions**: Enforce valid state machine transitions

---

## Performance Considerations

### Current localStorage Limitations
- No indexing
- Full table scans for filtering/searching
- No pagination at storage level
- JSON parse/stringify on every operation

### Backend Optimizations Needed
- Index all filter/search fields
- Implement pagination (limit/offset or cursor-based)
- Full-text search on orders (name, email, message)
- Cache settings/content (rarely change)
- Aggregate queries for dashboard stats

### Calculated Dashboard Metrics
The admin panel computes:
- Total/new/processing/completed order counts
- Monthly growth percentages
- Revenue totals and trends
- Average order value
- Daily order chart (last 7 days)

**Backend consideration**: Pre-compute or cache these metrics.

---

## Security Considerations

### Current State (Client-Side)
- No authentication on data access
- Admin password hardcoded
- All data visible in localStorage
- No data encryption
- Client-side price calculations (tamperable)

### Backend Requirements
1. **Authentication**: JWT or session-based auth
2. **Authorization**: Role-based access control (admin/user)
3. **Validation**: Server-side validation of all inputs
4. **Price integrity**: Recalculate prices server-side
5. **Rate limiting**: On order submissions and API calls
6. **Input sanitization**: XSS prevention
7. **SQL injection protection**: Parameterized queries
8. **HTTPS**: All API traffic encrypted
9. **Secrets management**: Telegram bot token in environment variables

---

## Migration Strategy

### Phase 1: Read-only API
- Build API that reads from localStorage export
- Test with admin panel
- Validate data transformations

### Phase 2: Write Operations
- Implement POST/PUT/DELETE endpoints
- Dual-write (localStorage + API)
- Validate consistency

### Phase 3: Full Migration
- Export all production data
- Transform and import to backend
- Switch admin panel to API
- Remove localStorage operations

### Data Transformation Script Requirements
```javascript
// Pseudocode
function transformOrder(localStorageOrder) {
  return {
    // Consolidate fields
    name: localStorageOrder.clientName || localStorageOrder.name,
    email: localStorageOrder.clientEmail || localStorageOrder.email,
    phone: localStorageOrder.clientPhone || localStorageOrder.phone,
    message: localStorageOrder.details || localStorageOrder.message,
    
    // Keep other fields
    type: localStorageOrder.type,
    status: localStorageOrder.status,
    // ... etc
    
    // Extract calculator data to separate table/JSON field
    calculatorData: localStorageOrder.calculatorData,
  };
}
```

---

## API Response Formats

### Success Response
```json
{
  "success": true,
  "data": { ... },
  "message": "Operation successful"
}
```

### Error Response
```json
{
  "success": false,
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": { ... }
}
```

### Paginated Response
```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "perPage": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

---

## Changelog Requirements

Consider adding audit trail for:
- Order status changes
- Settings modifications (especially pricing)
- Admin actions (deletes, approvals)

Structure:
```json
{
  "id": "...",
  "entityType": "order",
  "entityId": "...",
  "action": "update",
  "field": "status",
  "oldValue": "new",
  "newValue": "processing",
  "userId": "...",
  "timestamp": "..."
}
```

---

## Appendix: File Locations

### Client-Side Code
- **Database**: `/js/database.js` - All CRUD operations and default data
- **Config**: `/config.js` - Global configuration and pricing
- **Main App**: `/js/main.js` - Public site logic
- **Admin Panel**: `/js/admin.js` - Admin CRUD interfaces
- **Calculator**: `/js/calculator.js` - Price calculation logic
- **Validators**: `/js/validators.js` - Form validation
- **Telegram**: `/js/telegram.js` - Telegram bot integration

### HTML Pages
- **Public Site**: `/index.html`
- **Admin Panel**: `/admin.html`

---

## Summary

This data model documentation provides:
- ✅ Complete field-level specifications for all 8 collections
- ✅ Data types, constraints, and validation rules
- ✅ Default values and initial seeding data
- ✅ Relationships and implicit references
- ✅ Computed fields and business logic
- ✅ Enumeration values and state machines
- ✅ Required API endpoints
- ✅ Data transformation recommendations for relational schema
- ✅ Security and performance considerations
- ✅ Migration strategy guidelines

This document serves as the **single source of truth** for backend API development, database schema design, and data migration planning.
